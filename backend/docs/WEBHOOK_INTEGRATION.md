# Webhook Notification System\n\nThe AI Career Counseling system includes a comprehensive webhook notification system that sends alerts to parents, counselors, and external systems when career recommendations are generated.\n\n## Features\n\n### Core Functionality\n- **Automatic Notifications**: Triggered when career recommendations are generated\n- **Multiple Delivery Methods**: Console logging, HTTP webhooks, and n8n workflow integration\n- **Graceful Error Handling**: System continues to work even if notifications fail\n- **Retry Logic**: Automatic retry with exponential backoff for failed webhook deliveries\n- **Security**: Webhook signature validation using HMAC-SHA256\n\n### Supported Integrations\n- **HTTP Webhooks**: Standard webhook delivery to any HTTP endpoint\n- **n8n Workflows**: Direct integration with n8n automation platform\n- **Console Logging**: Structured logging for monitoring and debugging\n\n## Configuration\n\n### Environment Variables\n\n```bash\n# Webhook Configuration\nWEBHOOK_URL=https://your-webhook-endpoint.com/notify\nWEBHOOK_SECRET=your-webhook-secret-key\nWEBHOOK_RETRY_ATTEMPTS=3\nWEBHOOK_RETRY_DELAY=1000\nWEBHOOK_TIMEOUT=5000\nWEBHOOK_MAX_PAYLOAD_SIZE=1048576\n\n# n8n Integration\nENABLE_N8N_INTEGRATION=true\nN8N_WEBHOOK_URL=https://your-n8n-instance.com/webhook/career-notifications\n```\n\n### Webhook Payload Structure\n\nWhen a student receives career recommendations, the following payload is sent:\n\n```json\n{\n  \"event\": \"career_recommendations_generated\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"student\": {\n    \"name\": \"Student Name\",\n    \"grade\": \"12\",\n    \"board\": \"CBSE\",\n    \"location\": \"Delhi\",\n    \"profileId\": \"profile_abc123\"\n  },\n  \"recommendations\": [\n    {\n      \"title\": \"Software Engineer\",\n      \"matchScore\": 85,\n      \"demandLevel\": \"high\",\n      \"averageSalary\": 600000\n    }\n  ],\n  \"metadata\": {\n    \"totalRecommendations\": 3,\n    \"averageMatchScore\": 82,\n    \"processingTime\": 1500,\n    \"language\": \"english\"\n  },\n  \"n8nWorkflow\": {\n    \"triggerUrl\": \"https://n8n.example.com/webhook/trigger\"\n  }\n}\n```\n\n## API Endpoints\n\n### Send Notification\n`POST /api/notify`\n\nSend a notification webhook with student profile and recommendations.\n\n**Request Body:**\n```json\n{\n  \"studentProfile\": {\n    \"id\": \"profile_123\",\n    \"personalInfo\": {\n      \"name\": \"Student Name\",\n      \"grade\": \"12\",\n      \"board\": \"CBSE\",\n      \"languagePreference\": \"english\"\n    },\n    \"socioeconomicData\": {\n      \"location\": \"Delhi\"\n    }\n  },\n  \"recommendations\": [\n    {\n      \"id\": \"rec_1\",\n      \"title\": \"Software Engineer\",\n      \"matchScore\": 85,\n      \"prospects\": {\n        \"demandLevel\": \"high\",\n        \"averageSalary\": {\n          \"entry\": 600000\n        }\n      }\n    }\n  ],\n  \"processingTime\": 1500,\n  \"metadata\": {\n    \"source\": \"profile-controller\",\n    \"requestId\": \"req_123\"\n  }\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"notificationId\": \"notify_abc123_def456\",\n    \"deliveryStatus\": {\n      \"webhookDelivered\": true,\n      \"consoleLogged\": true,\n      \"n8nTriggered\": false\n    },\n    \"deliveryTime\": 250,\n    \"attempts\": 1\n  },\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\"\n}\n```\n\n### Test Webhook\n`GET /api/notify/test`\n\nTest webhook connectivity and response time.\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"webhookUrl\": \"https://your-webhook-endpoint.com/notify\",\n    \"responseTime\": 150,\n    \"status\": \"Webhook test successful (200)\"\n  },\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\"\n}\n```\n\n### Get Statistics\n`GET /api/notify/stats`\n\nRetrieve notification service statistics.\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"totalNotifications\": 150,\n    \"successCount\": 145,\n    \"failureCount\": 5,\n    \"successRate\": 96.67,\n    \"config\": {\n      \"webhookUrl\": \"https://your-webhook-endpoint.com/notify\",\n      \"enableConsoleLogging\": true,\n      \"retryAttempts\": 3\n    },\n    \"controller\": {\n      \"requestCount\": 75,\n      \"uptime\": 3600\n    }\n  },\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\"\n}\n```\n\n### Health Check\n`GET /api/notify/health`\n\nCheck the health status of the notification service.\n\n**Response:**\n```json\n{\n  \"status\": \"healthy\",\n  \"services\": {\n    \"notificationService\": \"healthy\",\n    \"webhook\": \"healthy\",\n    \"console\": \"healthy\",\n    \"n8n\": \"configured\"\n  },\n  \"stats\": {\n    \"totalNotifications\": 150,\n    \"successRate\": 96.67,\n    \"requestCount\": 75\n  },\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\"\n}\n```\n\n### Receive Webhook\n`POST /api/notify/receive`\n\nEndpoint for receiving and testing webhook deliveries.\n\n## Security\n\n### Webhook Signature Validation\n\nWhen `WEBHOOK_SECRET` is configured, all webhook requests include an `X-Webhook-Signature` header with HMAC-SHA256 signature:\n\n```\nX-Webhook-Signature: sha256=abc123def456...\n```\n\n### Rate Limiting\n\n- Webhook endpoints are rate-limited to prevent abuse\n- Default: 100 requests per 15 minutes per IP address\n- Configurable via `WEBHOOK_RATE_LIMIT` environment variable\n\n### Input Validation\n\n- All webhook payloads are validated against strict schemas\n- Malformed requests are rejected with detailed error messages\n- Payload size limits prevent resource exhaustion\n\n## Integration Examples\n\n### Parent/Counselor Notification System\n\n```javascript\n// Example webhook receiver for parent notifications\napp.post('/webhook/career-notifications', (req, res) => {\n  const { student, recommendations, metadata } = req.body;\n  \n  // Send email to parents\n  sendEmailToParents({\n    studentName: student.name,\n    grade: student.grade,\n    topCareer: recommendations[0].title,\n    matchScore: recommendations[0].matchScore,\n    totalRecommendations: metadata.totalRecommendations\n  });\n  \n  // Send SMS to counselor\n  sendSMSToCounselor({\n    message: `New career recommendations for ${student.name} (Grade ${student.grade}). Top match: ${recommendations[0].title} (${recommendations[0].matchScore}% match)`\n  });\n  \n  res.json({ success: true });\n});\n```\n\n### n8n Workflow Integration\n\n1. **Create n8n Workflow**:\n   - Add Webhook trigger node\n   - Configure webhook URL in environment variables\n   - Add processing nodes (email, SMS, database, etc.)\n\n2. **Example n8n Workflow**:\n   ```\n   Webhook Trigger â†’ Filter Node â†’ Email Node â†’ Database Node\n   ```\n\n3. **Workflow Configuration**:\n   - **Webhook URL**: `https://your-n8n.com/webhook/career-notifications`\n   - **HTTP Method**: POST\n   - **Authentication**: None (handled by signature validation)\n\n### Slack Integration Example\n\n```javascript\n// Slack webhook receiver\napp.post('/webhook/slack-notifications', async (req, res) => {\n  const { student, recommendations } = req.body;\n  \n  const slackMessage = {\n    text: `ðŸŽ“ New Career Recommendations Generated`,\n    blocks: [\n      {\n        type: \"section\",\n        text: {\n          type: \"mrkdwn\",\n          text: `*Student:* ${student.name} (Grade ${student.grade})\\n*Location:* ${student.location}\\n*Board:* ${student.board}`\n        }\n      },\n      {\n        type: \"section\",\n        text: {\n          type: \"mrkdwn\",\n          text: `*Top Recommendations:*\\n${recommendations.map(r => `â€¢ ${r.title} (${r.matchScore}% match)`).join('\\n')}`\n        }\n      }\n    ]\n  };\n  \n  await fetch(process.env.SLACK_WEBHOOK_URL, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(slackMessage)\n  });\n  \n  res.json({ success: true });\n});\n```\n\n## Monitoring and Debugging\n\n### Console Logging\n\nThe system provides structured console logging for monitoring:\n\n```\nðŸ”” CAREER RECOMMENDATION NOTIFICATION: {\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"event\": \"career_recommendations_generated\",\n  \"student\": \"Student Name\",\n  \"grade\": \"12\",\n  \"location\": \"Delhi\",\n  \"recommendations\": 3,\n  \"averageMatch\": 85,\n  \"topCareer\": \"Software Engineer\",\n  \"language\": \"english\"\n}\n```\n\n### Error Handling\n\n- **Graceful Degradation**: System continues to work even if webhooks fail\n- **Retry Logic**: Automatic retry with exponential backoff\n- **Error Logging**: Detailed error logs for debugging\n- **Partial Success**: Returns 207 status for partial delivery success\n\n### Performance Monitoring\n\n- **Delivery Time Tracking**: Monitor webhook response times\n- **Success Rate Metrics**: Track delivery success rates\n- **Request Counting**: Monitor API usage patterns\n- **Health Checks**: Regular connectivity testing\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Webhook Not Receiving Notifications**\n   - Check `WEBHOOK_URL` configuration\n   - Verify webhook endpoint is accessible\n   - Test connectivity with `/api/notify/test`\n\n2. **Signature Validation Failures**\n   - Ensure `WEBHOOK_SECRET` matches on both ends\n   - Verify signature generation algorithm (HMAC-SHA256)\n   - Check for payload modification during transit\n\n3. **High Failure Rates**\n   - Monitor webhook endpoint response times\n   - Check for rate limiting on receiving end\n   - Review error logs for specific failure patterns\n\n4. **n8n Integration Issues**\n   - Verify `N8N_WEBHOOK_URL` is correct\n   - Check n8n workflow is active\n   - Test n8n webhook independently\n\n### Debug Commands\n\n```bash\n# Test webhook connectivity\ncurl -X GET http://localhost:3001/api/notify/test\n\n# Check notification statistics\ncurl -X GET http://localhost:3001/api/notify/stats\n\n# Health check\ncurl -X GET http://localhost:3001/api/notify/health\n\n# Send test notification\ncurl -X POST http://localhost:3001/api/notify \\\n  -H \"Content-Type: application/json\" \\\n  -d @test-notification.json\n```\n\n## Best Practices\n\n1. **Security**\n   - Always use HTTPS for webhook URLs\n   - Configure webhook secrets for signature validation\n   - Implement proper authentication on receiving endpoints\n\n2. **Reliability**\n   - Design webhook receivers to be idempotent\n   - Implement proper error handling and logging\n   - Use appropriate timeout values\n\n3. **Performance**\n   - Keep webhook processing lightweight\n   - Use background processing for heavy operations\n   - Monitor response times and success rates\n\n4. **Monitoring**\n   - Set up alerts for high failure rates\n   - Monitor webhook endpoint availability\n   - Track processing times and success metrics\n\n## Future Enhancements\n\n- **Message Queuing**: Redis/RabbitMQ integration for reliable delivery\n- **Template System**: Customizable notification templates\n- **Multi-Channel**: SMS, email, and push notification support\n- **Analytics**: Advanced notification analytics and reporting\n- **Webhook Management**: UI for managing webhook configurations\n"